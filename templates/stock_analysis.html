{% extends "base_simple.html" %}

{% block title %}{{ symbol }} Analysis - GridTrader Pro{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Stock Header -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">{{ company_info.longName or symbol }}</h1>
                <p class="text-xl text-gray-600 mt-2">{{ symbol }}</p>
                <div class="flex space-x-4 mt-2">
                    <span class="text-sm text-gray-500">{{ company_info.sector or "Unknown Sector" }}</span>
                    <span class="text-sm text-gray-500">•</span>
                    <span class="text-sm text-gray-500">{{ company_info.industry or "Unknown Industry" }}</span>
                </div>
            </div>
            <div class="text-right">
                <div class="text-3xl font-bold text-gray-900">${{ "%.2f"|format(current_price) }}</div>
                <div class="text-sm text-gray-600">Current Price</div>
                <div class="text-sm text-green-600 mt-1">
                    <i class="fas fa-chart-line mr-1"></i> Live Price
                </div>
            </div>
        </div>
        
        <!-- Quick Stats -->
        <div class="grid grid-cols-4 gap-4 mt-6 pt-6 border-t">
            <div class="text-center">
                <div class="text-lg font-semibold text-gray-900">
                    {% if company_info.marketCap %}
                        ${{ "%.1fB"|format(company_info.marketCap / 1000000000) }}
                    {% else %}
                        N/A
                    {% endif %}
                </div>
                <div class="text-sm text-gray-600">Market Cap</div>
            </div>
            <div class="text-center">
                <div class="text-lg font-semibold text-gray-900">
                    {{ "%.2f"|format(company_info.peRatio or 0) if company_info.peRatio else "N/A" }}
                </div>
                <div class="text-sm text-gray-600">P/E Ratio</div>
            </div>
            <div class="text-center">
                <div class="text-lg font-semibold text-gray-900">
                    ${{ "%.2f"|format(company_info.get('52WeekHigh', 0)) }}
                </div>
                <div class="text-sm text-gray-600">52W High</div>
            </div>
            <div class="text-center">
                <div class="text-lg font-semibold text-gray-900">
                    ${{ "%.2f"|format(company_info.get('52WeekLow', 0)) }}
                </div>
                <div class="text-sm text-gray-600">52W Low</div>
            </div>
        </div>
        
        <div class="flex space-x-3 mt-6">
            <button onclick="history.back()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">
                ← Back
            </button>
            <button onclick="refreshAnalysis()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                <i class="fas fa-sync-alt mr-1"></i> Refresh Data
            </button>
        </div>
    </div>
    
    <!-- Price Chart -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-900 mb-4">Price Chart</h2>
        
        <!-- Chart Time Period Buttons -->
        <div class="flex space-x-2 mb-4">
            <button onclick="loadChart('1d')" class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700" id="btn-1d">1D</button>
            <button onclick="loadChart('5d')" class="px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300" id="btn-5d">5D</button>
            <button onclick="loadChart('1m')" class="px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300" id="btn-1m">1M</button>
            <button onclick="loadChart('3m')" class="px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300" id="btn-3m">3M</button>
        </div>
        
        <!-- Chart Container -->
        <div class="h-96 bg-gray-50 rounded-lg flex items-center justify-center" id="chart-container">
            <div class="text-center">
                <i class="fas fa-chart-line text-4xl text-gray-300 mb-4"></i>
                <p class="text-gray-500 mb-4">{{ symbol }} Price Chart</p>
                <button onclick="loadChart('1d')" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                    Load Chart
                </button>
            </div>
        </div>
        <canvas id="priceChart" style="display: none;" width="800" height="400"></canvas>
    </div>
    
    <!-- Company Information -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-900 mb-4">Company Information</h2>
        
        <div class="grid grid-cols-2 gap-6">
            <div>
                <h3 class="text-lg font-medium text-gray-900 mb-3">Basic Info</h3>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Company:</span>
                        <span class="text-sm font-medium">{{ company_info.longName or symbol }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Sector:</span>
                        <span class="text-sm font-medium">{{ company_info.sector or "Unknown" }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Industry:</span>
                        <span class="text-sm font-medium">{{ company_info.industry or "Unknown" }}</span>
                    </div>
                </div>
            </div>
            
            <div>
                <h3 class="text-lg font-medium text-gray-900 mb-3">Key Metrics</h3>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Volume:</span>
                        <span class="text-sm font-medium">{{ "{:,}"|format(company_info.volume or 0) }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Avg Volume:</span>
                        <span class="text-sm font-medium">{{ "{:,}"|format(company_info.avgVolume or 0) }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Dividend Yield:</span>
                        <span class="text-sm font-medium">{{ "%.2f%"|format((company_info.dividendYield or 0) * 100) }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js for TrendWise-style charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>

<script>
let currentChart = null;
const chartData = {{ chart_data|tojson }};

function loadChart(period) {
    try {
        // Update button states
        document.querySelectorAll('[id^="btn-"]').forEach(btn => {
            btn.className = 'px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300';
        });
        document.getElementById(`btn-${period}`).className = 'px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700';
        
        // Show chart container
        document.getElementById('chart-container').style.display = 'none';
        document.getElementById('priceChart').style.display = 'block';
        
        // Destroy existing chart
        if (currentChart) {
            currentChart.destroy();
        }
        
        // Get data for selected period
        const data = chartData[period] || [];
        
        if (data.length === 0) {
            alert(`No ${period} data available for {{ symbol }}`);
            return;
        }
        
        // Prepare chart data
        const labels = data.map(d => {
            const date = new Date(d.Date || d.Datetime);
            if (period === '1d') {
                return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            } else {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
        });
        
        const prices = data.map(d => d.Close);
        
        // Create TrendWise-style chart
        const ctx = document.getElementById('priceChart').getContext('2d');
        currentChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '{{ symbol }} Price',
                    data: prices,
                    borderColor: '#3B82F6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: `{{ symbol }} - ${period.toUpperCase()} Price Chart`,
                        font: { size: 16, weight: 'bold' }
                    },
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        grid: { display: false }
                    },
                    y: {
                        beginAtZero: false,
                        grid: { color: 'rgba(0,0,0,0.1)' },
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toFixed(2);
                            }
                        }
                    }
                },
                elements: {
                    point: {
                        radius: 0,
                        hoverRadius: 4
                    }
                }
            }
        });
        
    } catch (error) {
        console.error('Chart loading error:', error);
        alert('Failed to load chart data');
    }
}

async function refreshAnalysis() {
    try {
        const button = document.querySelector('button[onclick="refreshAnalysis()"]');
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Refreshing...';
        button.disabled = true;
        
        // Refresh the page to get latest data
        window.location.reload();
        
    } catch (error) {
        console.error('Refresh error:', error);
        button.innerHTML = '<i class="fas fa-sync-alt mr-1"></i> Refresh Data';
        button.disabled = false;
    }
}

// Auto-load 1-day chart on page load
document.addEventListener('DOMContentLoaded', function() {
    if (chartData['1d'] && chartData['1d'].length > 0) {
        loadChart('1d');
    }
});
</script>
{% endblock %}
