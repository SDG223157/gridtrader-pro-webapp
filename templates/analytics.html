{% extends "base_simple.html" %}

{% block title %}Analytics - GridTrader Pro{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">Analytics</h1>
    
    <!-- Portfolio Summary Cards -->
    <!-- Systematic Trading Framework Metrics -->
    <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-5 mb-8">
        <!-- Market Regime -->
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-purple-500 rounded-md flex items-center justify-center">
                            <i class="fas fa-brain text-white"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Market Regime</dt>
                            <dd class="text-lg font-medium text-gray-900">{{ market_regime|title|replace('_', ' ') }}</dd>
                            <dd class="text-xs text-gray-600 mt-1">{{ regime_description }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Portfolio Risk Status -->
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 {% if risk_metrics.risk_status == 'HEALTHY' %}bg-green-500{% else %}bg-yellow-500{% endif %} rounded-md flex items-center justify-center">
                            <i class="fas fa-shield-alt text-white"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Risk Status</dt>
                            <dd class="text-lg font-medium text-gray-900">{{ risk_metrics.risk_status }}</dd>
                            <dd class="text-xs text-gray-600 mt-1">{{ "{:.1%}".format(risk_metrics.cash_percentage) }} cash buffer</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- US Market Sector Analysis -->
        <div class="bg-white overflow-hidden shadow rounded-lg cursor-pointer" onclick="loadSectorAnalysis('US')">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center">
                            <i class="fas fa-flag-usa text-white"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">US Market</dt>
                            <dd class="text-lg font-medium text-gray-900">Sector Analysis</dd>
                            <dd class="text-xs text-gray-600 mt-1">XLK, QQQ, ARKK, XLF, etc.</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- China Market Sector Analysis -->
        <div class="bg-white overflow-hidden shadow rounded-lg cursor-pointer" onclick="loadSectorAnalysis('China')">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-red-500 rounded-md flex items-center justify-center">
                            <i class="fas fa-dragon text-white"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">China Market</dt>
                            <dd class="text-lg font-medium text-gray-900">Sector Analysis</dd>
                            <dd class="text-xs text-gray-600 mt-1">513090.SS, 159915.SZ, etc.</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Risk Check -->
        <div class="bg-white overflow-hidden shadow rounded-lg cursor-pointer" onclick="runRiskCheck()">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-red-500 rounded-md flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-white"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Risk Check</dt>
                            <dd class="text-lg font-medium text-gray-900">Run Analysis</dd>
                            <dd class="text-xs text-gray-600 mt-1">Portfolio risk assessment</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Market Overview with TradingView S&P 500 -->
    <div class="bg-white shadow rounded-lg mb-8">
        <div class="px-4 py-5 sm:p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Market Overview</h3>
                <div class="flex items-center">
                    <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                    <span class="text-sm text-gray-600">Live S&P 500</span>
                    <button onclick="window.location.reload()" class="ml-3 text-blue-600 hover:text-blue-800">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            
            <!-- TradingView AAPL Widget -->
            <div id="tradingview_widget_container" style="height: 500px; width: 100%;">
                <div id="tradingview_aapl_chart" style="height: 100%; width: 100%;"></div>
            </div>
            <div class="mt-2 text-center">
                <a href="https://www.tradingview.com/" rel="noopener nofollow" target="_blank" class="text-xs text-gray-500">
                    AAPL powered by TradingView
                </a>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize TradingView AAPL Widget
function initAAPLTradingViewWidget() {
    try {
        console.log('üçé Initializing AAPL TradingView widget...');
        
        new TradingView.widget({
            "autosize": true,
            "symbol": "NASDAQ:AAPL",
            "interval": "D",
            "timezone": "America/New_York",
            "theme": "light",
            "style": "1",
            "locale": "en",
            "toolbar_bg": "#f1f3f6",
            "enable_publishing": false,
            "allow_symbol_change": true,
            "container_id": "tradingview_aapl_chart",
            "studies": [
                "Volume@tv-basicstudies",
                "MASimple@tv-basicstudies"
            ],
            "show_popup_button": true,
            "popup_width": "1000",
            "popup_height": "650",
            "details": true,
            "calendar": false
        });
        
        console.log('‚úÖ AAPL TradingView widget initialized successfully');
        
    } catch (error) {
        console.error('‚ùå Error initializing AAPL TradingView widget:', error);
        
        // Fallback: show error message
        const container = document.getElementById('tradingview_aapl_chart');
        if (container) {
            container.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500"><div class="text-center"><i class="fas fa-chart-line text-4xl mb-4"></i><p>Chart temporarily unavailable</p><button onclick="window.location.reload()" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded">Retry</button></div></div>';
        }
    }
}

// Load TradingView and initialize AAPL widget
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìä Loading TradingView for AAPL market overview...');
    
    // Load TradingView script
    const script = document.createElement('script');
    script.src = 'https://s3.tradingview.com/tv.js';
    script.onload = function() {
        console.log('‚úÖ TradingView script loaded, initializing AAPL widget...');
        // Initialize widget after script loads
        setTimeout(() => {
            initAAPLTradingViewWidget();
        }, 1000);
    };
    script.onerror = function() {
        console.error('‚ùå Failed to load TradingView script');
        const container = document.getElementById('tradingview_aapl_chart');
        if (container) {
            container.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500"><div class="text-center"><i class="fas fa-exclamation-triangle text-4xl mb-4"></i><p>Unable to load market chart</p></div></div>';
        }
    };
    document.head.appendChild(script);
});

// Systematic Trading Framework Functions

// Load sector rotation analysis for specific market
async function loadSectorAnalysis(market = 'US') {
    try {
        console.log(`üîç Loading ${market} market sector rotation analysis...`);
        
        const response = await fetch(`/api/sector-analysis?market=${market}&lookback_days=90`);
        const data = await response.json();
        
        if (data.success) {
            showSectorAnalysisModal(data);
        } else {
            alert(`Failed to load ${market} sector analysis`);
        }
    } catch (error) {
        console.error(`${market} sector analysis error:`, error);
        alert(`Failed to load ${market} sector analysis`);
    }
}

// Run comprehensive portfolio risk check
async function runRiskCheck() {
    try {
        console.log('üõ°Ô∏è Running portfolio risk check...');
        
        const response = await fetch('/api/portfolio-risk-check', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        
        if (data.success) {
            showRiskAnalysisModal(data);
        } else {
            alert('Failed to run risk check');
        }
    } catch (error) {
        console.error('Risk check error:', error);
        alert('Failed to run risk check');
    }
}

// Show sector analysis results in modal
function showSectorAnalysisModal(data) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-4xl max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">${data.market} Market Sector Analysis</h3>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <p class="text-sm text-gray-600">Market: <strong>${data.market === 'US' ? 'üá∫üá∏ United States' : 'üá®üá≥ China'}</strong></p>
                <p class="text-sm text-gray-600">Benchmark: <strong>${data.market === 'US' ? 'S&P 500 (SPY)' : 'CSI 300 Index (000300.SS)'}</strong></p>
                <p class="text-sm text-gray-600">Market Regime: <strong>${data.market_regime.replace('_', ' ').toUpperCase()}</strong></p>
                <p class="text-sm text-gray-600">Analyzed ${data.sectors_analyzed} sectors over ${data.lookback_days} days</p>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-2 text-left">Sector</th>
                            <th class="px-3 py-2 text-left">Symbol</th>
                            <th class="px-3 py-2 text-left">Conviction</th>
                            <th class="px-3 py-2 text-left">Weight</th>
                            <th class="px-3 py-2 text-left">Risk Adjustment</th>
                            <th class="px-3 py-2 text-left">Recommendation</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.top_sectors.slice(0, 10).map(sector => `
                            <tr class="border-b">
                                <td class="px-3 py-2 font-medium">${sector.sector.substring(0, 30)}...</td>
                                <td class="px-3 py-2 text-blue-600 font-mono">${sector.symbol}</td>
                                <td class="px-3 py-2">${sector.conviction_score.toFixed(2)}</td>
                                <td class="px-3 py-2">${sector.recommended_weight.toFixed(1)}%</td>
                                <td class="px-3 py-2">
                                    <span class="px-2 py-1 text-xs rounded font-mono ${
                                        sector.risk_adjustment >= 1.1 ? 'bg-green-100 text-green-800' :
                                        sector.risk_adjustment >= 1.0 ? 'bg-blue-100 text-blue-800' :
                                        sector.risk_adjustment >= 0.9 ? 'bg-yellow-100 text-yellow-800' :
                                        'bg-red-100 text-red-800'
                                    }">${sector.risk_adjustment.toFixed(3)}</span>
                                </td>
                                <td class="px-3 py-2">
                                    <span class="px-2 py-1 text-xs rounded ${
                                        sector.recommendation === 'STRONG_BUY' ? 'bg-green-100 text-green-800' :
                                        sector.recommendation === 'BUY' ? 'bg-blue-100 text-blue-800' :
                                        sector.recommendation === 'HOLD' ? 'bg-yellow-100 text-yellow-800' :
                                        'bg-red-100 text-red-800'
                                    }">${sector.recommendation}</span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Show risk analysis results in modal
function showRiskAnalysisModal(data) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-4xl max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">Portfolio Risk Analysis</h3>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <p class="text-sm text-gray-600">Overall Risk Status: <strong class="${
                    data.overall_risk_status === 'HEALTHY' ? 'text-green-600' :
                    data.overall_risk_status === 'LOW' ? 'text-yellow-600' :
                    data.overall_risk_status === 'MEDIUM' ? 'text-orange-600' : 'text-red-600'
                }">${data.overall_risk_status}</strong></p>
                <p class="text-sm text-gray-600">Total Alerts: ${data.total_alerts} (Level 1: ${data.alert_breakdown.level_1_daily}, Level 2: ${data.alert_breakdown.level_2_immediate}, Level 3: ${data.alert_breakdown.level_3_review})</p>
            </div>
            ${data.alerts.length > 0 ? `
                <div class="space-y-2">
                    ${data.alerts.map(alert => `
                        <div class="p-3 rounded border-l-4 ${
                            alert.level === 'strategy_review' ? 'border-red-500 bg-red-50' :
                            alert.level === 'immediate_action' ? 'border-orange-500 bg-orange-50' :
                            'border-yellow-500 bg-yellow-50'
                        }">
                            <div class="flex justify-between">
                                <div>
                                    <p class="font-medium">${alert.title}</p>
                                    <p class="text-sm text-gray-600">${alert.message}</p>
                                    <p class="text-xs text-gray-500 mt-1">${alert.action_required}</p>
                                </div>
                                <div class="text-right">
                                    <span class="text-sm font-mono">${alert.symbol || ''}</span>
                                    <p class="text-xs text-gray-500">${alert.deviation_pct.toFixed(1)}% deviation</p>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            ` : '<p class="text-gray-500 text-center py-4">No risk alerts - Portfolio is healthy!</p>'}
        </div>
    `;
    document.body.appendChild(modal);
}
</script>
{% endblock %}
