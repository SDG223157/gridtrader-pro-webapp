{% extends "base_simple.html" %}

{% block title %}Settings - GridTrader Pro{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">
            <i class="fas fa-cog text-blue-600 mr-3"></i>Settings
        </h1>
        <p class="text-gray-600">Manage your account preferences and trading settings</p>
    </div>
    
    <div class="max-w-4xl mx-auto">
        <div class="bg-white shadow rounded-lg divide-y divide-gray-200">
            <!-- Profile Section -->
            <div class="px-6 py-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Profile Settings</h3>
                    <button onclick="editProfile()" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                        <i class="fas fa-edit mr-1"></i>Edit
                    </button>
                </div>
                
                <div class="space-y-4" id="profileDisplay">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Display Name</label>
                        <p class="mt-1 text-sm text-gray-900">{{ user.profile.display_name if user.profile else user.email.split('@')[0] }}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Email</label>
                        <p class="mt-1 text-sm text-gray-900">{{ user.email }}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Account Type</label>
                        <p class="mt-1 text-sm text-gray-900">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                                {{ user.subscription_tier|title }}
                            </span>
                        </p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Timezone</label>
                        <p class="mt-1 text-sm text-gray-900">{{ user.profile.timezone if user.profile else 'UTC' }}</p>
                    </div>
                </div>
                
                <!-- Edit Profile Form (Hidden by default) -->
                <form id="profileEditForm" style="display: none;" onsubmit="updateProfile(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Display Name</label>
                        <input type="text" name="display_name" 
                               value="{{ user.profile.display_name if user.profile else user.email.split('@')[0] }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Timezone</label>
                        <select name="timezone" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="UTC" {% if not user.profile or user.profile.timezone == 'UTC' %}selected{% endif %}>UTC</option>
                            <option value="US/Eastern" {% if user.profile and user.profile.timezone == 'US/Eastern' %}selected{% endif %}>US/Eastern</option>
                            <option value="US/Central" {% if user.profile and user.profile.timezone == 'US/Central' %}selected{% endif %}>US/Central</option>
                            <option value="US/Mountain" {% if user.profile and user.profile.timezone == 'US/Mountain' %}selected{% endif %}>US/Mountain</option>
                            <option value="US/Pacific" {% if user.profile and user.profile.timezone == 'US/Pacific' %}selected{% endif %}>US/Pacific</option>
                            <option value="Europe/London" {% if user.profile and user.profile.timezone == 'Europe/London' %}selected{% endif %}>Europe/London</option>
                            <option value="Asia/Shanghai" {% if user.profile and user.profile.timezone == 'Asia/Shanghai' %}selected{% endif %}>Asia/Shanghai</option>
                            <option value="Asia/Tokyo" {% if user.profile and user.profile.timezone == 'Asia/Tokyo' %}selected{% endif %}>Asia/Tokyo</option>
                        </select>
                    </div>
                    <div class="flex space-x-3">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                            Save Changes
                        </button>
                        <button type="button" onclick="cancelEdit()" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-md text-sm font-medium">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- MCP Integration -->
            <div class="px-6 py-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">
                        <i class="fas fa-robot text-blue-600 mr-2"></i>AI Integration (MCP)
                    </h3>
                    <a href="/tokens" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                        <i class="fas fa-key mr-1"></i>Manage Tokens
                    </a>
                </div>
                
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-info-circle text-blue-600 mt-1"></i>
                        </div>
                        <div class="ml-3">
                            <h4 class="text-sm font-medium text-blue-900">🤖 AI-Powered Trading</h4>
                            <p class="text-sm text-blue-700 mt-1">
                                Connect Cursor IDE to control your portfolios with natural language commands like "Show me my cash balances" or "Create a growth portfolio with $25,000"
                            </p>
                            <div class="mt-2">
                                <a href="#" onclick="showMcpSetupGuide()" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                                    📖 View Setup Guide
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="text-center p-3 border border-gray-200 rounded-lg">
                        <div class="text-lg mb-1">🔑</div>
                        <h4 class="text-sm font-medium text-gray-900">API Tokens</h4>
                        <p class="text-xs text-gray-600">Secure authentication</p>
                    </div>
                    <div class="text-center p-3 border border-gray-200 rounded-lg">
                        <div class="text-lg mb-1">🤖</div>
                        <h4 class="text-sm font-medium text-gray-900">MCP Server</h4>
                        <p class="text-xs text-gray-600">Global installation</p>
                    </div>
                    <div class="text-center p-3 border border-gray-200 rounded-lg">
                        <div class="text-lg mb-1">💬</div>
                        <h4 class="text-sm font-medium text-gray-900">Natural Language</h4>
                        <p class="text-xs text-gray-600">AI commands</p>
                    </div>
                </div>
            </div>
            
            <!-- Trading Preferences -->
            <div class="px-6 py-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Trading Preferences</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Default Portfolio Strategy</label>
                        <p class="mt-1 text-sm text-gray-900">Balanced</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Grid Trading Default Size</label>
                        <p class="mt-1 text-sm text-gray-900">10 levels</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Risk Management</label>
                        <p class="mt-1 text-sm text-gray-900">Conservative (5% max position size)</p>
                    </div>
                </div>
            </div>
            
            <!-- Notifications -->
            <div class="px-6 py-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Notifications</h3>
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="text-sm font-medium text-gray-900">Email Notifications</h4>
                            <p class="text-sm text-gray-500">Receive email updates about your portfolios</p>
                        </div>
                        <input type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    </div>
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="text-sm font-medium text-gray-900">Grid Alerts</h4>
                            <p class="text-sm text-gray-500">Get notified when grid strategies trigger</p>
                        </div>
                        <input type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    </div>
                </div>
            </div>
            
            <!-- Security -->
            <div class="px-6 py-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Security</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Authentication Provider</label>
                        <p class="mt-1 text-sm text-gray-900">{{ user.auth_provider|title }}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Account Created</label>
                        <p class="mt-1 text-sm text-gray-900">{{ user.created_at.strftime('%B %d, %Y') if user.created_at else 'Unknown' }}</p>
                    </div>
                </div>
            </div>
            
            <!-- Security -->
            <div class="px-6 py-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Security</h3>
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Authentication Provider</label>
                            <p class="mt-1 text-sm text-gray-900">
                                <span class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                    <i class="fab fa-google mr-1"></i>{{ user.auth_provider.value|title if user.auth_provider else 'Local' }}
                                </span>
                            </p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Account Created</label>
                            <p class="mt-1 text-sm text-gray-900">{{ user.created_at.strftime('%B %d, %Y') if user.created_at else 'Unknown' }}</p>
                        </div>
                    </div>
                    
                    <div class="border-t pt-4">
                        <h4 class="text-sm font-medium text-gray-900 mb-3">API Access</h4>
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-700">API Tokens</p>
                                <p class="text-xs text-gray-500">Manage tokens for MCP integration</p>
                            </div>
                            <a href="/tokens" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-md text-sm font-medium">
                                <i class="fas fa-key mr-1"></i>Manage
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Actions -->
            <div class="px-6 py-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Account Actions</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button onclick="exportData()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-download mr-2"></i>Export Data
                    </button>
                    <button onclick="refreshAllData()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh Data
                    </button>
                    <a href="/logout" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm font-medium text-center">
                        <i class="fas fa-sign-out-alt mr-2"></i>Sign Out
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function editProfile() {
    document.getElementById('profileDisplay').style.display = 'none';
    document.getElementById('profileEditForm').style.display = 'block';
}

function cancelEdit() {
    document.getElementById('profileDisplay').style.display = 'block';
    document.getElementById('profileEditForm').style.display = 'none';
}

async function updateProfile(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    
    try {
        const response = await fetch('/api/settings/profile', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('✅ Profile updated successfully!');
            location.reload();
        } else {
            alert('❌ Failed to update profile: ' + (result.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('❌ Failed to update profile. Please try again.');
        console.error('Profile update error:', error);
    }
}

function showMcpSetupGuide() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-blue-600">
                    <i class="fas fa-robot mr-2"></i>MCP Setup Guide
                </h3>
                <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-6">
                <div class="bg-blue-50 border border-blue-200 rounded-md p-4">
                    <h4 class="text-sm font-medium text-blue-800 mb-2">
                        <i class="fas fa-lightbulb mr-2"></i>Quick Setup Steps
                    </h4>
                    <ol class="text-sm text-blue-700 space-y-2 list-decimal list-inside">
                        <li><strong>Install MCP Server:</strong> <code>npm install -g gridtrader-pro-mcp</code></li>
                        <li><strong>Create API Token:</strong> <a href="/tokens" class="underline">Visit Tokens Page</a></li>
                        <li><strong>Configure Cursor:</strong> Add MCP settings to Cursor IDE</li>
                        <li><strong>Restart Cursor:</strong> Reload to activate MCP server</li>
                        <li><strong>Test:</strong> Ask "Show me my portfolios"</li>
                    </ol>
                </div>
                
                <div class="bg-green-50 border border-green-200 rounded-md p-4">
                    <h4 class="text-sm font-medium text-green-800 mb-2">
                        <i class="fas fa-comments mr-2"></i>Example Commands
                    </h4>
                    <ul class="text-sm text-green-700 space-y-1 list-disc list-inside">
                        <li>"Show me my cash balances"</li>
                        <li>"Create a growth portfolio with $25,000"</li>
                        <li>"Set up a grid for AAPL between $150-200"</li>
                        <li>"What's my portfolio performance?"</li>
                        <li>"Update my cash balance to reflect interest earned"</li>
                    </ul>
                </div>
                
                <div class="text-center">
                    <a href="/tokens" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-md font-medium">
                        <i class="fas fa-key mr-2"></i>Create API Token Now
                    </a>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

async function exportData() {
    try {
        alert('📊 Data export functionality coming soon!\\n\\nThis will allow you to export:\\n• Portfolio data\\n• Transaction history\\n• Grid trading strategies\\n• Performance metrics');
    } catch (error) {
        console.error('Export error:', error);
    }
}

async function refreshAllData() {
    try {
        const button = event.target;
        const originalText = button.innerHTML;
        
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Refreshing...';
        button.disabled = true;
        
        // Simulate refresh (you can implement actual refresh logic)
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        alert('✅ All data refreshed successfully!\\n\\n• Portfolio values updated\\n• Market prices refreshed\\n• Grid strategies checked');
        
        button.innerHTML = originalText;
        button.disabled = false;
        
    } catch (error) {
        alert('❌ Failed to refresh data. Please try again.');
        console.error('Refresh error:', error);
    }
}
</script>
{% endblock %}
