{% extends "base_simple.html" %}

{% block title %}{{ grid.name }} - Grid Details{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">{{ grid.name }}</h1>
            <p class="text-gray-600 mt-1">{{ grid.symbol }} Grid Trading Strategy</p>
        </div>
        <div class="flex space-x-3">
            <a href="/grids" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">
                ‚Üê Back to Grids
            </a>
            {% if grid.status.value == 'active' %}
            <button onclick="pauseGrid('{{ grid.id }}')" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded">
                Pause Grid
            </button>
            {% elif grid.status.value == 'paused' %}
            <button onclick="resumeGrid('{{ grid.id }}')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                Resume Grid
            </button>
            {% endif %}
            <button onclick="deleteGrid('{{ grid.id }}')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                Delete Grid
            </button>
        </div>
    </div>

    <!-- Grid Overview -->
    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Current Price -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Current Price</h3>
            <p class="text-3xl font-bold text-blue-600">${{ "{:.2f}".format(current_price) }}</p>
            <p class="text-sm text-gray-500 mt-1">{{ grid.symbol }}</p>
        </div>

        <!-- Investment Amount -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Investment</h3>
            <p class="text-3xl font-bold text-green-600">${{ "{:,.2f}".format(grid.investment_amount) }}</p>
            <p class="text-sm text-gray-500 mt-1">Total allocated</p>
        </div>

        <!-- Total Profit -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Total Profit</h3>
            <p class="text-3xl font-bold {% if total_profit >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                ${{ "{:,.2f}".format(total_profit) }}
            </p>
            <p class="text-sm text-gray-500 mt-1">{{ "{:.2f}%".format(grid_performance.roi) }} ROI</p>
        </div>

        <!-- Status -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Status</h3>
            <p class="text-2xl font-bold 
               {% if grid.status.value == 'active' %}text-green-600
               {% elif grid.status.value == 'paused' %}text-yellow-600
               {% else %}text-gray-600{% endif %}">
                {{ grid.status.value|title }}
            </p>
            <p class="text-sm text-gray-500 mt-1">{{ grid.active_orders }} active orders</p>
        </div>
    </div>

    <!-- Grid Configuration -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-xl font-bold text-gray-900 mb-4">Grid Configuration</h2>
        <div class="grid md:grid-cols-3 gap-6">
            <div>
                <h4 class="font-semibold text-gray-700">Price Range</h4>
                <p class="text-sm text-gray-600">Upper: ${{ "{:.2f}".format(grid.upper_price) }}</p>
                <p class="text-sm text-gray-600">Lower: ${{ "{:.2f}".format(grid.lower_price) }}</p>
                <p class="text-sm text-gray-600">Spacing: ${{ "{:.2f}".format(grid.grid_spacing) }}</p>
            </div>
            <div>
                <h4 class="font-semibold text-gray-700">Grid Setup</h4>
                {% if grid.symbol.endswith('.SS') or grid.symbol.endswith('.SZ') or grid.symbol.endswith('.HK') %}
                    <p class="text-sm text-gray-600">Total Levels: {{ orders|list|length }} ({{ orders|selectattr("order_type.value", "equalto", "buy")|list|length }} buy + {{ orders|selectattr("order_type.value", "equalto", "sell")|list|length }} sell)</p>
                    {% set buy_orders = orders|selectattr("order_type.value", "equalto", "buy")|list %}
                    {% if buy_orders %}
                        <p class="text-sm text-gray-600">Per Buy Level: ${{ "{:,.0f}".format((buy_orders[0].target_price * buy_orders[0].quantity)) }}</p>
                    {% else %}
                        <p class="text-sm text-gray-600">Per Buy Level: ${{ "{:,.0f}".format(grid.investment_amount / 6) }}</p>
                    {% endif %}
                    <p class="text-xs text-blue-600">üá®üá≥ Full grid, buy-funded only</p>
                {% else %}
                    <p class="text-sm text-gray-600">Levels: {{ grid.strategy_config.grid_count }}</p>
                    <p class="text-sm text-gray-600">Per Level: ${{ "{:,.2f}".format(grid.strategy_config.price_per_grid) }}</p>
                {% endif %}
            </div>
            <div>
                <h4 class="font-semibold text-gray-700">Performance</h4>
                <p class="text-sm text-gray-600">Filled Orders: {{ total_filled_orders }}</p>
                <p class="text-sm text-gray-600">Completed: {{ grid.completed_orders }}</p>
            </div>
        </div>
    </div>

    <!-- Grid Orders Table -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-gray-900">Grid Orders</h2>
            <div class="text-sm text-gray-500">
                Current Price: ${{ "{:.2f}".format(current_price) }}
            </div>
        </div>
        
        {% if orders %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Target Price</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Filled Price</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Filled At</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for order in orders %}
                    <tr class="{% if order.target_price <= current_price and order.order_type.value == 'buy' %}bg-green-50{% elif order.target_price >= current_price and order.order_type.value == 'sell' %}bg-red-50{% endif %}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full
                                {% if order.order_type.value == 'buy' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                {{ order.order_type.value|upper }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            ${{ "{:.2f}".format(order.target_price) }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {{ "{:.4f}".format(order.quantity) }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full
                                {% if order.status.value == 'filled' %}bg-green-100 text-green-800
                                {% elif order.status.value == 'pending' %}bg-yellow-100 text-yellow-800
                                {% elif order.status.value == 'cancelled' %}bg-gray-100 text-gray-800
                                {% else %}bg-red-100 text-red-800{% endif %}">
                                {{ order.status.value|title }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {% if order.filled_price %}
                                ${{ "{:.2f}".format(order.filled_price) }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {% if order.filled_at %}
                                {{ order.filled_at.strftime('%Y-%m-%d %H:%M') }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-8">
            <p class="text-gray-500">No grid orders found.</p>
        </div>
        {% endif %}
    </div>

    <!-- Grid Visualization -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-bold text-gray-900 mb-4">Grid Visualization</h2>
        {% if grid.symbol.endswith('.SS') or grid.symbol.endswith('.SZ') or grid.symbol.endswith('.HK') %}
        <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
            <div class="flex items-center">
                <span class="text-blue-600 mr-2">üá®üá≥</span>
                <span class="text-sm font-medium text-blue-800">China/HK Market Grid</span>
            </div>
            <p class="text-xs text-blue-600 mt-1">Full 12-level grid: $1M allocated to BUY levels only, SELL orders unfunded initially</p>
        </div>
        {% endif %}
        <div class="relative">
            <!-- Current Price Indicator -->
            <div class="mb-4 p-3 bg-blue-100 border-l-4 border-blue-500 rounded">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <span class="text-sm font-medium text-gray-700">Current Market Price</span>
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                            CURRENT
                        </span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-lg font-bold text-blue-900">${{ "{:.2f}".format(current_price) }}</span>
                        <span class="text-xs text-blue-600">{{ grid.symbol }}</span>
                    </div>
                </div>
            </div>
            
            <!-- Active Orders (sorted by price) -->
            <div class="space-y-2">
                {% set order_counter = [0] %}
                {% for order in orders|sort(attribute='target_price') %}
                {% set _ = order_counter.append(order_counter.pop() + 1) %}
                <div class="flex items-center justify-between p-3 rounded-lg
                    {% if order.order_type.value == 'buy' %}bg-green-50 border-l-4 border-green-500
                    {% elif order.quantity == 0 %}bg-gray-50 border-l-4 border-gray-300
                    {% else %}bg-red-50 border-l-4 border-red-500{% endif %}">
                    
                    <div class="flex items-center space-x-4">
                        <span class="text-sm font-medium text-gray-700">Level {{ order_counter[-1] }}</span>
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full
                            {% if order.order_type.value == 'buy' %}bg-green-100 text-green-800
                            {% else %}bg-red-100 text-red-800{% endif %}">
                            {{ order.order_type.value|upper }}
                        </span>
                        {% if order.quantity == 0 and order.order_type.value == 'sell' %}
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-600">
                            UNFUNDED
                        </span>
                        {% else %}
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full
                            {% if order.status.value == 'filled' %}bg-green-100 text-green-800
                            {% elif order.status.value == 'pending' %}bg-yellow-100 text-yellow-800
                            {% elif order.status.value == 'cancelled' %}bg-gray-100 text-gray-800
                            {% else %}bg-red-100 text-red-800{% endif %}">
                            {{ order.status.value|title }}
                        </span>
                        {% endif %}
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <span class="text-sm font-bold text-gray-900">${{ "{:.2f}".format(order.target_price) }}</span>
                        {% if order.quantity == 0 %}
                        <span class="text-xs text-gray-400">0 shares</span>
                        <span class="text-xs text-gray-400">$0 (unfunded)</span>
                        {% else %}
                        <span class="text-xs text-gray-600">{{ "{:,.0f}".format(order.quantity) }} shares</span>
                        <span class="text-xs text-gray-500">${{ "{:,.0f}".format(order.target_price * order.quantity) }}</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            
            {% if not orders %}
            <div class="text-center py-8 text-gray-500">
                <p>No active orders found</p>
                <p class="text-sm">Grid orders will appear here once they are created</p>
            </div>
            {% endif %}
        </div>
        
        <!-- Grid Statistics -->
        <div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="text-center p-3 bg-gray-50 rounded-lg">
                <div class="text-lg font-bold text-gray-900">{{ orders|selectattr("order_type.value", "equalto", "buy")|list|length }}</div>
                <div class="text-xs text-gray-600">Buy Orders</div>
            </div>
            <div class="text-center p-3 bg-gray-50 rounded-lg">
                <div class="text-lg font-bold text-gray-900">{{ orders|selectattr("order_type.value", "equalto", "sell")|list|length }}</div>
                <div class="text-xs text-gray-600">Sell Orders</div>
            </div>
            <div class="text-center p-3 bg-gray-50 rounded-lg">
                <div class="text-lg font-bold text-gray-900">{{ orders|selectattr("status.value", "equalto", "pending")|list|length }}</div>
                <div class="text-xs text-gray-600">Pending</div>
            </div>
            <div class="text-center p-3 bg-gray-50 rounded-lg">
                <div class="text-lg font-bold text-gray-900">{{ orders|selectattr("status.value", "equalto", "filled")|list|length }}</div>
                <div class="text-xs text-gray-600">Filled</div>
            </div>
        </div>
    </div>
</div>

<script>
async function pauseGrid(gridId) {
    if (!confirm('Are you sure you want to pause this grid strategy?')) return;
    
    try {
        const response = await fetch(`/api/grids/${gridId}/pause`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        if (result.success) {
            alert('Grid paused successfully!');
            window.location.reload();
        } else {
            alert(result.detail || 'Failed to pause grid');
        }
    } catch (error) {
        alert('Failed to pause grid. Please try again.');
    }
}

async function resumeGrid(gridId) {
    if (!confirm('Are you sure you want to resume this grid strategy?')) return;
    
    try {
        const response = await fetch(`/api/grids/${gridId}/resume`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        if (result.success) {
            alert('Grid resumed successfully!');
            window.location.reload();
        } else {
            alert(result.detail || 'Failed to resume grid');
        }
    } catch (error) {
        alert('Failed to resume grid. Please try again.');
    }
}

async function deleteGrid(gridId) {
    if (!confirm('Are you sure you want to delete this grid strategy? This will return all invested funds to your portfolio cash balance and permanently remove the grid.')) return;
    
    try {
        const response = await fetch(`/api/grids/${gridId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        if (result.success) {
            const fundsReturned = result.funds_returned || 0;
            const ordersDeleted = result.orders_deleted || 0;
            alert(`Grid deleted successfully!\n\nFunds returned: $${fundsReturned.toLocaleString()}\nOrders deleted: ${ordersDeleted}\n\nThe grid has been completely removed and funds returned to your portfolio.`);
            window.location.href = '/grids';
        } else {
            alert(result.detail || 'Failed to delete grid');
        }
    } catch (error) {
        alert('Failed to delete grid. Please try again.');
    }
}
</script>
{% endblock %}
